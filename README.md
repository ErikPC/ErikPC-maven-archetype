# stonarini-maven-archetype

Template/Tutorial to create a custom archetype for Maven.  
Features:

- [x] Configure directory structure
- [x] JaCoCo and JUnit
- [x] jar manifest
- [x] Dockerfile
- [x] Auto-Incrementing Version

## Quick install

For those who want to use the archetype as-is, just clone the repo and execute mvn install:

```
git clone https://www.github.com/stonarini/stonarini-maven-archetype
cd stonarini-maven-archetype
mvn install
```

Then when you create a new maven proyect in your favorite IDE you'll be able to select the archetype.
If you use IntelliJ though, you'll need to add it manually; First create a new proyect, and when you need to
select a Maven archetype, search for a button that says _Add New..._, and introduce the following (changing the current version):
![](add-to-intellij.png)

## Features

Before going into how to create your custom archetype, I will explain the features my archetype has, to give you some inspiration.

First I've added the basic maven plugins; Then I've also "locked" the Java version to JRE-11.  
Then I've added the JUnit dependency for testing and the JaCoCo plugin to check code coverage.  
After that I've added a _.gitignore_.

Then I've played a little bit with Docker, and I decided to add an autogenerated, ready-to-go Dockerfile, just build and run.  
Last but not least I've added a little script to update the version in both the pom and the Dockefile for those lazy people out there ;)

## The Basics

The first thing to know it's the basic structure and files we will need.  
From the [official documentation](https://maven.apache.org/guides/mini/guide-creating-archetypes.html):

```
archetype/
|-- pom.xml
`-- src/
    `-- main/
        `-- resources/
            |-- META-INF/
            |   `-- maven/
            |       `--archetype-metadata.xml
            `-- archetype-resources/
                |-- pom.xml
                `-- src/
                    |-- main/
                    |   `-- java/
                    |       `-- App.java
                    `-- test/
                        `-- java/
                            `-- AppTest.java
```

Let's brake it down:

## archetype pom.xml

We start with the root directory _archetype_; In here we have to create a basic maven structure with a _pom.xml_ and a _src/_ directory with a _main/_ subdirectory.  
Now, instead of having a _java/_ directory like a normal proyect, we have to create a directory called _resources/_.  
Our directory structure should look like this:

```
archetype/
|-- pom.xml
`-- src/main/resources/
```

In the _pom.xml_ we just need to specify basic information. You can copy [my example](pom.xml) or the one from the [documentation](https://maven.apache.org/guides/mini/guide-creating-archetypes.html). Remember to change the project's _groupId_ and _artifactId_ to match your own.

## archetype-metadata.xml

Now in this _resources/_ directory we need to create two more directories, _META-INF_ and _maven_ so our directory structure should look like this:

```
archetype/
|-- pom.xml
`-- src/main/resources/META-INF/maven/archetype-metadata.xml
```

We should also create a xml file called _archetype-metadata.xml_.This file contains the information about what directory structure we want the archetype to automatically create.

```xml
<archetype-descriptor xmlns="https://maven.apache.org/plugins/maven-archetype-plugin/archetype-descriptor/1.1.0"
					  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
					  xsi:schemaLocation="https://maven.apache.org/plugins/maven-archetype-plugin/archetype-descriptor/1.1.0 https://maven.apache.org/xsd/archetype-descriptor-1.1.0.xsd"
					  name="stonarini-archetype">
    <fileSets>
        <fileSet filtered="true" packaged="true">
            <directory>src/main/java</directory>
            <includes>
                <include>**/*.java</include>
            </includes>
        </fileSet>
        <fileSet filtered="true" packaged="true">
            <directory>src/test/java</directory>
            <includes>
                <include>**/*.java</include>
            </includes>
        </fileSet>
    </fileSets>
</archetype-descriptor>
<!-- archetype-metadata.xml -->
```

In this file we need to change the _name_ attribute so that is the same as the _attributeId_ in our _pom.xml_. Then, in the _fileSets_ tag we need to specify the "raw" directory structure. In my case, I specified a simple maven structure with main and test.

The `packaged` attribute is needed if you want the directories of your _groupId_ to be created:

```yaml
groupId: edu.poniperro
```

```toml
packaged="false"
# src/
# |-- main/java/
# `-- test/java/
```

```toml
packaged="true"
# src/
# |-- main/java/edu/poniperro
# `-- test/java/edu/poniperro
```

While the `filtered` attribute is needed if you want to access the project's parameters inside a file, pay attention to the _${package}_:

```java
// filtered="false" (default)
package ${package};

public class App {
    public static void main(String[] args) {
        System.out.println("filtered=false");
    }
}
```

```java
// filtered="true"
package edu.poniperro;

public class App {
    public static void main(String[] args) {
        System.out.println("filtered=true");
    }
}
```

Last but not least, the _includes_ tag. In this tag we can specify specific files we want to copy every time we use the archetype. I used a generic syntax to copy every java file present.

```xml
<include>**/*.java</include>
```

## archetype-resources

Now we need to head back to the _resources_ directory.  
Here we are going to create a directory named _archetype-resources_. In this directory we will create a template for the archetype that should follow the structure declared in the _archetype-metadata.xml_, so in my case:

```
archetype-resources/
|-- pom.xml
`-- src/
	|-- main/
	|   `-- java/
	|       `-- App.java
	`-- test/
            `-- java/
                `-- AppTest.java
```

Now this template is special because we can access parameters such as the groupId, attributeId, package, etc... that we will provide to the archetype when we will use it.  
To access this properties use a dollar and curly braces:

```sh
${attributeId}
```

If filtered is set to true this parameters are accessible to all files (java, xml, etc). If filtered is false only the _pom.xml_ will have access to this properties.

## Template pom.xml

Now, addressing the [elephant in the room](https://raw.githubusercontent.com/devicons/devicon/2ae2a900d2f041da66e950e4d48052658d850630/icons/gradle/gradle-plain.svg), you will need to customise this pom.xml as you like.  
[My example](src/main/resources/archetype-resources/pom.xml) has the very much needed JUnit dependency and the core maven plugins. The only added plugin is the JaCoCo one.  
I also added some custom configuration for the jar manifest.

So, summing up, beside using the "dollar" parameters, configure this file as you see fit for your project.

A very basic example could look like this:

```xml
<project xmlns="http://maven.apache.org/POM/4.0.0"
		 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		 xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>${groupId}</groupId>
    <artifactId>${artifactId}</artifactId>
    <version>${version}</version>

    <name>${artifactId}</name>
</project>
```

## Building/Packaging the archetype

This is definetly the easiest part of the process.
To create a _.jar_ out of your archetype and automatically install it, just open a terminal in the root directory (where our original _pom.xml_ is) and run the command:

```sh
mvn install
```

## Create a project using the new Archetype

Now I will illustrate how to create a new project using directly maven. Afaik _VSCode_ should automatically aknowledge the new archetype.

To create a new project with the archetype use the following command:

```sh
mvn archetype:generate                                    \
	-DarchetypeGroupId=<archetype-groupId>                \
	-DarchetypeArtifactId=<archetype-artifactId>          \
	-DarchetypeVersion=<archetype-version>                \
	-DgroupId=<my.groupid>                                \
	-DartifactId=<my-artifactId>
```

Where **\<archetype-groupId>**, **\<archetype-artifactId>** and **\<archetype-version>** are the parameters specified in the _archetype pom.xml_.  
While **\<my.groupid>** is the package name (ie: edu.poniperro), and **\<my-artifactId>** is the project name.

---

# Modificar Archetype para tus datos.

### Modificamos el pom.xml

Primero vamos a modifical el pom.xml que aparece en la carpeta raiz. Vamos el tag artifactId , y ponemos el nombre del archetype que queremos que aparezca.

```xml
    <groupId>edu.poniperro</groupId>
    <artifactId>ErikPC-maven-archetype</artifactId>
    <version>1.3</version>
    <packaging>maven-archetype</packaging>
```

### Modificamos el segundo pom.xml

A continuaci√≥n vamos a ir al tag url para cambiar la url a nuestro github.

```xml
    <name>${artifactId}</name>
    <url>https://www.github.com/ErikPC/${artifactId}</url>
```

### Modificamos archetype-metadata.xml

Vamos a cambiar el archetype descriptor a el nombre del archetype y el mail.

```xml
<archetype-descriptor xmlns="https://maven.apache.org/plugins/maven-archetype-plugin/archetype-descriptor/1.1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="https://maven.apache.org/plugins/maven-archetype-plugin/archetype-descriptor/1.1.0 https://maven.apache.org/xsd/archetype-descriptor-1.1.0.xsd" name="ErikPC-maven-archetype">

    <requiredProperties>
        <requiredProperty key="gitignore">
            <defaultValue>.gitignore</defaultValue>
        </requiredProperty>
        <requiredProperty key="mantainer">
            <defaultValue>epardillo@cifpfbmoll.eu</defaultValue>
        </requiredProperty>
    </requiredProperties>
```
